<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Journal</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        /* Reset and base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%);
            color: #2d3748;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Header */
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 20"><defs><pattern id="grain" width="100" height="20" patternUnits="userSpaceOnUse"><circle cx="5" cy="5" r="1" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="20" fill="url(%23grain)"/></svg>');
            opacity: 0.1;
        }

        h1 {
            font-size: 2.2rem;
            font-weight: 600;
            margin-bottom: 5px;
            z-index: 1;
            position: relative;
        }

        header p {
            font-size: 1.1rem;
            opacity: 0.9;
            z-index: 1;
            position: relative;
        }

        /* Login Form */
        #login-form {
            padding: 50px;
            display: flex;
            flex-direction: column;
            gap: 25px;
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
        }

        label {
            font-weight: 500;
            color: #4a5568;
            font-size: 0.95rem;
        }

        input, select, textarea {
            padding: 14px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #f7fafc;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        button:hover::before {
            left: 100%;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .demo-note {
            text-align: center;
            color: #a0aec0;
            font-size: 0.9rem;
            font-style: italic;
        }

        /* Main App */
        #main-app {
            display: none;
            padding: 50px;
            animation: slideUp 0.6s ease-out;
        }

        .form-section {
            margin-bottom: 40px;
            padding: 30px;
            background: #f8f9ff;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }

        .form-section h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2d3748;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .conditional-field {
            display: none;
            animation: fadeIn 0.3s ease-out;
        }

        .pnl-display {
            font-size: 1.3rem;
            font-weight: 600;
            text-align: center;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            transition: all 0.3s ease;
        }

        .pnl-positive {
            background: linear-gradient(135deg, #c6f6d5 0%, #9ae6b4 100%);
            color: #22543d;
            border: 2px solid #68d391;
            transform: scale(1.02);
        }

        .pnl-negative {
            background: linear-gradient(135deg, #fed7d7 0%, #fc8181 100%);
            color: #742a2a;
            border: 2px solid #fc8181;
            transform: scale(1.02);
        }

        .pnl-zero {
            background: linear-gradient(135deg, #fef5e7 0%, #f6e05e 100%);
            color: #744210;
            border: 2px solid #f6ad55;
            transform: scale(1.02);
        }

        /* Trades List */
        .trades-list {
            margin-top: 40px;
        }

        .trades-list h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2d3748;
        }

        .trade-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        .trade-card:hover {
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .trade-header {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 0;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
            word-wrap: break-word;
            hyphens: auto;
            line-height: 1.3;
        }

        .trade-header::before {
            content: 'üìà';
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .trade-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 10px;
        }

        .trade-detail {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f7fafc;
            word-wrap: break-word;
        }

        .trade-detail:last-child {
            border-bottom: none;
        }

        .trade-detail span:first-child {
            font-weight: 500;
            color: #4a5568;
            min-width: 80px;
            flex-shrink: 0;
        }

        .trade-detail span:last-child {
            font-weight: 500;
            text-align: right;
        }

        .trade-pnl {
            text-align: center;
            font-size: 1.2rem;
            font-weight: 600;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            width: 100%;
        }

        .trade-pnl.pnl-positive {
            background: linear-gradient(135deg, #c6f6d5 0%, #9ae6b4 100%);
            color: #22543d;
            border: 2px solid #68d391;
        }

        .trade-pnl.pnl-negative {
            background: linear-gradient(135deg, #fed7d7 0%, #fc8181 100%);
            color: #742a2a;
            border: 2px solid #fc8181;
        }

        .trade-pnl.pnl-zero {
            background: linear-gradient(135deg, #fef5e7 0%, #f6e05e 100%);
            color: #744210;
            border: 2px solid #f6ad55;
        }

        .trade-notes {
            font-style: italic;
            color: #718096;
            background: #f7fafc;
            padding: 12px;
            border-radius: 8px;
            border-left: 3px solid #cbd5e0;
            word-wrap: break-word;
            line-height: 1.4;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .trade-details {
                grid-template-columns: 1fr;
            }

            #login-form, #main-app {
                padding: 30px 20px;
            }

            .form-section {
                padding: 20px;
            }

            h1 {
                font-size: 1.8rem;
            }

            .trade-card {
                padding: 15px;
            }
        }

        @media (max-width: 480px) {
            .container {
                margin: 10px;
                border-radius: 12px;
            }

            header {
                padding: 20px;
            }

            .trade-header {
                font-size: 1rem;
            }
        }

        /* Summary Stats */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 12px;
        }

        .stat-card {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #718096;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Trading Journal</h1>
            <p>Track, reflect, and grow your trading journey</p>
        </header>

        <!-- Login Form -->
        <div id="login-form">
            <form id="loginForm">
                <div class="form-group">
                    <label for="email">Email or Username</label>
                    <input type="text" id="email" placeholder="Enter your email or username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" placeholder="Enter your password" required>
                </div>
                <button type="submit">Login & Track Trades</button>
                <p class="demo-note">(Demo Mode: Use any credentials to proceed)</p>
            </form>
        </div>

        <!-- Main App -->
        <div id="main-app">
            <div class="stats-bar" id="statsBar" style="display: none;">
                <div class="stat-card">
                    <div class="stat-value" id="totalTrades">0</div>
                    <div class="stat-label">Total Trades</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalPnL">‚Çπ0.00</div>
                    <div class="stat-label">Total PnL</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="winRate">0%</div>
                    <div class="stat-label">Win Rate</div>
                </div>
            </div>

            <div class="form-section">
                <h2>Add New Trade</h2>
                <form id="tradeForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="date">Trade Date</label>
                            <input type="date" id="date" required>
                        </div>
                        <div class="form-group">
                            <label for="symbol">Symbol</label>
                            <input type="text" id="symbol" placeholder="e.g., RELIANCE, NIFTY" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="scripType">Type of Scrip</label>
                        <select id="scripType" required>
                            <option value="">Select Type</option>
                            <option value="stock">Stock</option>
                            <option value="option">Option</option>
                            <option value="future">Future</option>
                        </select>
                    </div>

                    <!-- Conditional Fields for Option -->
                    <div id="optionFields" class="conditional-field form-row">
                        <div class="form-group">
                            <label for="cePe">CE or PE</label>
                            <select id="cePe">
                                <option value="">Select</option>
                                <option value="CE">CE (Call)</option>
                                <option value="PE">PE (Put)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="strikePrice">Strike Price</label>
                            <input type="number" id="strikePrice" step="0.01" placeholder="e.g., 25000">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="quantity">Quantity (Lots/Shares)</label>
                            <input type="number" id="quantity" min="1" value="1" required>
                        </div>
                        <div class="form-group">
                            <label for="sellPrice">Sell Price</label>
                            <input type="number" id="sellPrice" step="0.01" placeholder="e.g., 150.50" required>
                        </div>
                        <div class="form-group">
                            <label for="buyPrice">Buy Price</label>
                            <input type="number" id="buyPrice" step="0.01" placeholder="e.g., 145.00" required>
                        </div>
                    </div>

                    <div id="pnlDisplay" class="pnl-display" style="display: none;"></div>

                    <div class="form-group">
                        <label for="notes">Trade Notes & Reflections</label>
                        <textarea id="notes" rows="4" placeholder="What went well? Lessons learned? Market conditions?"></textarea>
                    </div>

                    <button type="submit">Save Trade</button>
                </form>
            </div>

            <div class="trades-list">
                <h2>Your Recent Trades</h2>
                <div id="tradesContainer"></div>
            </div>
        </div>
    </div>

    <script>
        // Replace 'YOUR_APPS_SCRIPT_URL' with your Web App URL from Step 2
        const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbz4GMjeQmYVfltwiWDBdT1AdSQ6B1Qb6TIRmI_dEdwMsruaeRGfqC2ryWOHSlRSxMPr6w/exec';  // Paste your URL here, end with /exec if not there

        let currentUser = null;
        let trades = [];

        // Login handling
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();
            if (!email || !password) return alert('Please enter email and password.');

            try {
                // First try login
                let response = await fetch(`\( {BACKEND_URL}?action=login&email= \){encodeURIComponent(email)}&password=${encodeURIComponent(password)}`);
                let result = await response.json();
                if (result.success) {
                    currentUser = email;
                    document.getElementById('login-form').style.display = 'none';
                    document.getElementById('main-app').style.display = 'block';
                    loadTrades();
                    document.getElementById('statsBar').style.display = 'grid';
                    document.getElementById('date').value = new Date().toISOString().split('T')[0];
                } else {
                    // If not registered, register
                    response = await fetch(`\( {BACKEND_URL}?action=register&email= \){encodeURIComponent(email)}&password=${encodeURIComponent(password)}`);
                    result = await response.json();
                    if (result.success) {
                        currentUser = email;
                        document.getElementById('login-form').style.display = 'none';
                        document.getElementById('main-app').style.display = 'block';
                        loadTrades();
                        document.getElementById('statsBar').style.display = 'grid';
                        document.getElementById('date').value = new Date().toISOString().split('T')[0];
                    } else {
                        alert(result.message);
                    }
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });

        // Load trades from Sheets
        async function loadTrades() {
            if (!currentUser) return;
            try {
                const response = await fetch(`\( {BACKEND_URL}?action=getTrades&email= \){encodeURIComponent(currentUser)}`);
                trades = await response.json();
                renderTrades();
                updateStats();
            } catch (error) {
                console.error('Load error:', error);
                trades = [];
                renderTrades();
                updateStats();
            }
        }

        // Scrip type change handler (same as before)
        document.getElementById('scripType').addEventListener('change', (e) => {
            const optionFields = document.getElementById('optionFields');
            const cePe = document.getElementById('cePe');
            const strikePrice = document.getElementById('strikePrice');
            if (e.target.value === 'option') {
                optionFields.style.display = 'grid';
                cePe.required = true;
                strikePrice.required = true;
            } else {
                optionFields.style.display = 'none';
                cePe.required = false;
                strikePrice.required = false;
                cePe.value = '';
                strikePrice.value = '';
            }
        });

        // Price/quantity change - calculate PnL (same as before)
        document.getElementById('buyPrice').addEventListener('input', calculatePnL);
        document.getElementById('sellPrice').addEventListener('input', calculatePnL);
        document.getElementById('quantity').addEventListener('input', calculatePnL);

        function calculatePnL() {
            const sell = parseFloat(document.getElementById('sellPrice').value) || 0;
            const buy = parseFloat(document.getElementById('buyPrice').value) || 0;
            const qty = parseFloat(document.getElementById('quantity').value) || 1;
            const pnl = qty * (sell - buy);
            const display = document.getElementById('pnlDisplay');
            display.style.display = 'block';
            display.innerHTML = `<span>Estimated PnL: ‚Çπ${pnl.toFixed(2)}</span>`;
            if (pnl > 0) {
                display.className = 'pnl-display pnl-positive';
            } else if (pnl < 0) {
                display.className = 'pnl-display pnl-negative';
            } else {
                display.className = 'pnl-display pnl-zero';
            }
        }

        // Trade form submit - now saves to Sheets
        document.getElementById('tradeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return alert('Please login first.');
            const scripType = document.getElementById('scripType').value || 'stock';
            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            const sell = parseFloat(document.getElementById('sellPrice').value) || 0;
            const buy = parseFloat(document.getElementById('buyPrice').value) || 0;
            const pnl = quantity * (sell - buy);
            const cePe = document.getElementById('cePe').value || '';
            const strikePrice = document.getElementById('strikePrice').value || '';
            const trade = {
                email: currentUser,
                date: document.getElementById('date').value,
                symbol: document.getElementById('symbol').value.trim().toUpperCase(),
                scripType,
                cePe,
                strikePrice,
                quantity,
                sellPrice: sell,
                buyPrice: buy,
                pnl,
                notes: document.getElementById('notes').value.trim()
            };
            if (!trade.symbol) return alert('Please enter a symbol.');

            try {
                const response = await fetch(`${BACKEND_URL}?action=saveTrade&` + new URLSearchParams(trade));
                const result = await response.json();
                if (result.success) {
                    loadTrades();  // Reload to show new trade
                    e.target.reset();
                    document.getElementById('pnlDisplay').style.display = 'none';
                    document.getElementById('optionFields').style.display = 'none';
                    document.getElementById('scripType').value = '';
                    document.getElementById('cePe').value = '';
                    document.getElementById('strikePrice').value = '';
                    document.getElementById('quantity').value = 1;
                    alert('Trade saved!');
                } else {
                    alert('Save failed.');
                }
            } catch (error) {
                alert('Error saving: ' + error.message);
            }
        });

        // Render trades (same as before, but uses global trades array)
        function renderTrades() {
            const container = document.getElementById('tradesContainer');
            if (trades.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #a0aec0; font-style: italic;">No trades yet. Add your first one above!</p>';
                return;
            }
            container.innerHTML = trades.slice(0, 50).map(trade => {
                const scripTypeUpper = trade.scripType ? trade.scripType.toUpperCase() : 'STOCK';
                const strikePart = (trade.cePe && trade.strikePrice) ? ` ${trade.cePe} @ ${trade.strikePrice}` : '';
                const header = `${trade.date} - \( {trade.symbol} ( \){scripTypeUpper}${strikePart})`;
                const pnlClass = trade.pnl > 0 ? 'pnl-positive' : trade.pnl < 0 ? 'pnl-negative' : 'pnl-zero';
                return `
                    <div class="trade-card">
                        <div class="trade-header">${header}</div>
                        <div class="trade-details">
                            <div class="trade-detail"><span>Quantity:</span><span>${trade.quantity || 1}</span></div>
                            <div class="trade-detail"><span>Sell Price:</span><span>‚Çπ${(trade.sellPrice || 0).toFixed(2)}</span></div>
                            <div class="trade-detail"><span>Buy Price:</span><span>‚Çπ${(trade.buyPrice || 0).toFixed(2)}</span></div>
                        </div>
                        <div class="trade-pnl \( {pnlClass}">PnL: ‚Çπ \){(trade.pnl || 0).toFixed(2)}</div>
                        ${trade.notes ? `<div class="trade-notes">üìù ${trade.notes}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        // Update stats (same as before)
        function updateStats() {
            const totalTrades = trades.length;
            const totalPnL = trades.reduce((sum, t) => sum + (t.pnl || 0), 0);
            const wins = trades.filter(t => (t.pnl || 0) > 0).length;
            const winRate = totalTrades > 0 ? ((wins / totalTrades) * 100).toFixed(1) : 0;

            document.getElementById('totalTrades').textContent = totalTrades;
            document.getElementById('totalPnL').textContent = `‚Çπ${totalPnL.toFixed(2)}`;
            document.getElementById('totalPnL').style.color = totalPnL > 0 ? '#38a169' : totalPnL < 0 ? '#e53e3e' : '#ed8936';
            document.getElementById('winRate').textContent = `${winRate}%`;
        }
    </script>
</body>
</html>